name: CI/CD Pipeline

on:
  pull_request:
    branches: [ "main" ]
  push:
    branches: [ "main" ]

permissions:
  contents: read
  security-events: write

jobs:
  build-and-test:
    name: Build and Test
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 21
          cache: maven

      - name: Build and run tests
        run: mvn clean verify

  build-docker:
    name: Build and Scan Docker Image
    runs-on: ubuntu-latest
    needs: [build-and-test]

    env:
      EMAIL_USERNAME: ${{ secrets.EMAIL_USERNAME }}
      EMAIL_PASSWORD: ${{ secrets.EMAIL_PASSWORD }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          load: true
          tags: notification-service:${{ github.sha }}
          build-args: |
            EMAIL_USERNAME=${{ env.EMAIL_USERNAME }}
            EMAIL_PASSWORD=${{ env.EMAIL_PASSWORD }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Scan Docker image with Trivy
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: notification-service:${{ github.sha }}
          format: 'sarif'
          output: 'trivy-image-results.sarif'
          severity: 'CRITICAL,HIGH'

      - name: Upload Trivy image scan results
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: 'trivy-image-results.sarif'

      - name: Save Docker image
        run: |
          docker save notification-service:${{ github.sha }} -o notification-service.tar

      - name: Upload Docker image artifact
        uses: actions/upload-artifact@v4
        with:
          name: docker-image
          path: notification-service.tar
          retention-days: 1

  deploy-kubernetes:
    name: Deploy to Kubernetes
    runs-on: ubuntu-latest
    needs: [build-docker]

    env:
      EMAIL_USERNAME: ${{ secrets.EMAIL_USERNAME }}
      EMAIL_PASSWORD: ${{ secrets.EMAIL_PASSWORD }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download Docker image
        uses: actions/download-artifact@v4
        with:
          name: docker-image

      - name: Start Minikube
        uses: medyagh/setup-minikube@latest
        with:
          kubernetes-version: 'v1.28.3'

      - name: Load Docker image into Minikube
        run: |
          docker load -i notification-service.tar
          minikube image load notification-service:${{ github.sha }}

      - name: Deploy to Kubernetes
        run: |
          kubectl create namespace notification-service --dry-run=client -o yaml | kubectl apply -f -
          kubectl create secret generic notification-service-secret \
            --namespace=notification-service \
            --from-literal=EMAIL_USERNAME="${{ env.EMAIL_USERNAME }}" \
            --from-literal=EMAIL_PASSWORD="${{ env.EMAIL_PASSWORD }}" \
            --from-literal=SPRING_DATASOURCE_PASSWORD="" \
            --dry-run=client -o yaml | kubectl apply -f -
          kubectl apply -f k8s/namespace.yaml
          kubectl apply -f k8s/configmap.yaml
          kubectl apply -f k8s/deployment.yaml
          kubectl apply -f k8s/service.yaml

      - name: Verify deployment
        run: |
          kubectl rollout status deployment/notification-service -n notification-service --timeout=5m
          kubectl wait --for=condition=ready pod -l app=notification-service -n notification-service --timeout=5m
          kubectl get pods -n notification-service
          kubectl get services -n notification-service